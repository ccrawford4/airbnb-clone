<% content_for :listing do %>
  <%= stylesheet_link_tag 'listings', media: 'all', 'data-turbolinks-track': 'reload' %>
<% end %>

<div class="listing-creation">
  <header class="header">
    <%= link_to root_path, class: "logo" do %>
      <%= image_tag @logo_url, alt: "Logo", height: 32, width: 32 %>
    <% end %>
    
    <div class="header-actions">
      <button class="questions-btn">Questions?</button>
      <button class="save-exit-btn">Save & exit</button>
    </div>
  </header>

  <main class="main-content">
    <div class="step-indicator">
      <p>Step <%= @current_step %></p>
    </div>

  <% if @current_step.to_i == 1 %>
    <%= render 'welcome_page' %>
    <% elsif @current_step.to_i == 2%>
      <%= render 'select_rental_type' %>
    <% elsif @current_step.to_i == 3 %>
      <%= render 'new_location' %>
    <% elsif @current_step.to_i == 4%>
      <%= render 'provide_rental_basics' %>
    <% elsif @current_step.to_i == 5 %>
        <%= render 'confirm_details' %>
    <% end %>
    
    <p>Address: <%= @address %></p>
     <% if Rails.env.development? %>
        <div class="debug-info">
          <p>Session Address: <%= session[:address].inspect %></p>
          <p>Instance Address: <%= @address.inspect %></p>
          <p>Rental Id: <%= @rental.id %></p>
        </div>
      <% end %>
    <div class="navigation-buttons">
      <% unless @current_step.to_i == 1 %>
        <%= link_to "Back", new_rental_path(step: @current_step.to_i - 1), class: "back-btn" %>
      <% end %>
      
      <% if (@current_step.to_i == 2 && @selected_rental_type.nil?) || (@current_step.to_i == 3 && session[:address].nil?) %>
        <button class="next-btn" disabled>Next</button>
      <% else %>
        <%= link_to "Next", new_rental_path(step: @current_step + 1), class: "next-btn" %>
      <% end %>
    </div>
  </main>
</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const rentalTypeCards = document.querySelectorAll('.rental-type-card');
    const nextButton = document.getElementById('next-btn');

    rentalTypeCards.forEach(card => {
      card.addEventListener('click', () => {
        console.log("CARD: ", card);
        const rentalTypeId = card.getAttribute('data-rental-type-id');

        // Send AJAX request to update rental_type_id
        fetch('<%= new_rental_path %>', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '<%= form_authenticity_token %>'
          },
          body: JSON.stringify({ rental_type_id: rentalTypeId, step: <%= @current_step %> })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            rentalTypeCards.forEach(c => c.classList.remove('selected'));
            console.log("Card.classList: ", card.classList);
            card.classList.add('selected');
            nextButton.removeAttribute('disabled');
          }
        });
      });
    });
  });
</script>